#include <stdio.h>
#include <stdlib.h>
#include <EFM8LB1.h>

// ~C51~  

#define SYSCLK 24500000L
#define BAUDRATE 115200L

#define TH1_TH1__SHIFT 0x00 ///< Timer 1 High Byte
#define TL1_TL1__SHIFT 0x00 ///< Timer 1 Low Byte
#define TCON_TR0__RUN     0x10 ///< Start Timer 0 running.

#define F_SCK_MAX 2000000L  // Max SCK freq (Hz)
#define BLE_FREQ 112500L

// address for FUXB = 0x46 and 0x45
// address for current = 0xAA 0xAB


#define OLED_SELECT P0_3
#define ENABLE P1_2
#define CHARGE_EN P1_6
#define UNITC P1_7
#define NOTIF P2_0
#define DEADMAN P2_1
#define BOOT P2_2
#define LOWBAT P2_5
#define BLE_PWR P2_6
#define OLED_A0 P3_0
#define OLED_RESET P3_1
#define DISPLAY_LED1 P3_2
#define STATUS1 P3_3



const unsigned char vsn1 [] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xE0, 0xE0, 0xE0, 0xFC, 0xFC, 0xFC, 0xFC,
0xFC, 0xFC, 0xFC, 0xE0, 0xE0, 0xE0, 0xE0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0x38, 0x1C, 0x0E, 0xFF, 0xFF, 0xFF, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0,
0xF8, 0xFC, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x0C, 0x0E, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0C, 0x0C, 0x0C, 0x0F, 0x0F, 0x0F, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80,
0x00, 0xF0, 0x90, 0x90, 0x10, 0x00, 0xF0, 0x90, 0x90, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x90, 0x90, 0xE0, 0x00, 0xF0, 0x90, 0x90, 0x10,
0x00, 0x60, 0x90, 0x90, 0x60, 0x80, 0x60, 0x90, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x04, 0x04, 0x04, 0x03, 0x00, 0x04, 0x04, 0x04, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x03, 0x00, 0x04, 0x04, 0x04, 0x03,
0x00, 0x00, 0x00, 0x04, 0x03, 0x00, 0x03, 0x04, 0x04, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0,
0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0, 0xE0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xE0, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xE0,
0xE0, 0xC0, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x07, 0xFF, 0xFF, 0xFF, 0xFC, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0xF0, 0xFE, 0xFF, 0xFF, 0x0F, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01,
0x03, 0x07, 0x3F, 0xFF, 0xFE, 0xFC, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x80, 0xC0, 0xF0, 0xF8, 0xFE, 0x3F, 0x1F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x07, 0x3F, 0x7F, 0xFF, 0xFC, 0xF0, 0xE0, 0xE0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0,
0xE0, 0xE0, 0xF0, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0xE0, 0xF0, 0xF8, 0x7C,
0x3E, 0x1F, 0x0F, 0x07, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x01,
0x81, 0xC0, 0xF8, 0xFF, 0xFF, 0x1F, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3E, 0x3F, 0x3F, 0x3F, 0x3F, 0x3D, 0x3C, 0x3C,
0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x3C, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x7C, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x78, 0x3C, 0x3C, 0x3E, 0x1F,
0x0F, 0x0F, 0x07, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0xFC, 0x80, 0xC0, 0x20, 0x00, 0x00, 0xE0, 0x20, 0x20, 0xC0, 0x20, 0x20,
0xC0, 0x00, 0x00, 0x80, 0x70, 0x0C, 0xFC, 0x20, 0x20, 0x20, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x01, 0x02, 0x00, 0x03, 0x00, 0x00, 0x03, 0x00, 0x00,
0x03, 0x00, 0x0C, 0x03, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x04,
0x04, 0x02, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x33, 0x33, 0x33, 0x33, 0x33,
0x33, 0x33, 0x33, 0x33, 0x33, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x20, 0x30, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0x03, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0xBB, 0xFF, 0xFF, 0x1F, 0xE7, 0xF7, 0xFB,
0xFB, 0xFB, 0xFB, 0xF7, 0xFF, 0x1F, 0xE7, 0xF7, 0xFB, 0xFB, 0xFB, 0xF7, 0xE7, 0x1F, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F,
0x3F, 0x3F, 0x3F, 0x30, 0x37, 0x37, 0x37, 0x37, 0x37, 0x37, 0x3F, 0x3F, 0x3E, 0x39, 0x3B, 0x37,
0x37, 0x37, 0x37, 0x3B, 0x3F, 0x3E, 0x39, 0x3B, 0x37, 0x37, 0x37, 0x3B, 0x39, 0x3E, 0x3F, 0x3F,
0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F, 0x3F,
0x00, 0x00, 0x00, 0x00, 0xC0, 0x40, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0xC0, 0xC0, 0x00, 0x00,
0x00, 0xC0, 0x80, 0x00, 0x00, 0x00, 0xC0, 0x00, 0x00, 0x80, 0x40, 0x40, 0x40, 0x40, 0x00, 0xC0,
0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x40, 0x40, 0xC0, 0x40, 0x40, 0x00, 0x80, 0x40,
0x40, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x1F, 0x02, 0x06, 0x09, 0x10, 0x00, 0x18, 0x07, 0x04, 0x04, 0x07, 0x18,
0x00, 0x1F, 0x00, 0x01, 0x02, 0x04, 0x1F, 0x00, 0x07, 0x08, 0x10, 0x12, 0x12, 0x1E, 0x00, 0x1F,
0x12, 0x12, 0x12, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x00, 0x00, 0x07, 0x08, 0x10,
0x10, 0x10, 0x08, 0x07, 0x00, 0x00, 0x00, 0x00, 0x1F, 0x12, 0x12, 0x12, 0x10, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x88, 0x48, 0x30, 0x00, 0x08, 0x48, 0x48, 0xB0, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0x80,
0xC0, 0x20, 0x00, 0x00, 0xE0, 0x20, 0x20, 0xC0, 0x20, 0x20, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x02, 0x02, 0x02, 0x00, 0x02, 0x02, 0x02, 0x01, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00,
0x00, 0x01, 0x02, 0x00, 0x03, 0x00, 0x00, 0x03, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0x70, 0x7E, 0x7E, 0x7E, 0x7E, 0x7E, 0x7E, 0x7E,
0x70, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x90, 0x90, 0x60, 0x00, 0xF0, 0x90,
0x90, 0x90, 0x00, 0xE0, 0x30, 0xC0, 0x00, 0xC0, 0x30, 0xE0, 0x00, 0xC0, 0x20, 0x10, 0x10, 0x10,
0x20, 0xC0, 0x10, 0x10, 0xF0, 0x10, 0x10, 0x00, 0xF0, 0x90, 0x90, 0x90, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE, 0xFE,
0xFE, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x00, 0x81, 0x86, 0x00, 0x87, 0x84,
0x84, 0x04, 0x00, 0x07, 0x80, 0x83, 0x06, 0x01, 0x80, 0x07, 0x00, 0x01, 0x02, 0x04, 0x04, 0x04,
0x02, 0x01, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x07, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x27, 0x24, 0x24, 0x1B, 0x20, 0x30,
0x28, 0x27, 0x00, 0x07, 0x08, 0x38, 0x0F, 0x1E, 0x25, 0x24, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07,
0x07, 0x07, 0x07, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

volatile unsigned int btn_state = 0;
volatile unsigned int btn_type = 0;
volatile unsigned int btn_press = 0;
volatile unsigned int btn_debug = 0;

char _c51_external_startup (void)
{
// Disable Watchdog with key sequence

	SFRPAGE = 0x00;
	WDTCN = 0xDE; //First key
	WDTCN = 0xAD; //Second key
  
	VDM0CN=0x80;       // enable VDD monitor
	RSTSRC=0x02|0x04;  // Enable reset on missing clock detector and VDD

	#if (SYSCLK == 48000000L)	
		SFRPAGE = 0x10;
		PFE0CN  = 0x10; // SYSCLK < 50 MHz.
		SFRPAGE = 0x00;
	#elif (SYSCLK == 72000000L)
		SFRPAGE = 0x10;
		PFE0CN  = 0x20; // SYSCLK < 75 MHz.
		SFRPAGE = 0x00;
	#endif
	
	#if (SYSCLK == 12250000L)
		CLKSEL = 0x10;
		CLKSEL = 0x10;
		while ((CLKSEL & 0x80) == 0)
	#elif (SYSCLK == 24500000L)
		CLKSEL = 0x00;
		CLKSEL = 0x00;
		while ((CLKSEL & 0x80) == 0)
	#elif (SYSCLK == 48000000L)	
		// Before setting clock to 48 MHz, must transition to 24.5 MHz first
		CLKSEL = 0x00;
		CLKSEL = 0x00;
		while ((CLKSEL & 0x80) == 0)
		CLKSEL = 0x07;
		CLKSEL = 0x07;
		while ((CLKSEL & 0x80) == 0)
	#elif (SYSCLK == 72000000L)
		// Before setting clock to 72 MHz, must transition to 24.5 MHz first
		CLKSEL = 0x00;
		CLKSEL = 0x00;
		while ((CLKSEL & 0x80) == 0)
		CLKSEL = 0x03;
		CLKSEL = 0x03;
		while ((CLKSEL & 0x80) == 0)
	#else
		#error SYSCLK must be either 12250000L, 24500000L, 48000000L, or 72000000L
	#endif
	
	SFRPAGE = 0x00;
	P0MDOUT |= 0b1101_1101; // Enable UART0 TX as push-pull output
	P1MDOUT = 0b1000_0100;
	P2MDOUT = 0b0100_0001;
	PRTDRV = 0b0000_0100;
	SFRPAGE = 0x20;
	P3MDOUT = 0b0000_1111;
	SFRPAGE = 0x00;
	//PCON1 = 0b0000_0001; // DO NOT TURN ON. WILL MAKE CHIP BRAINDEAD
	
	//P0MDOUT |= 0b0100_0000; // Enable UART0 TX as push-pull output
	XBR0     = 0x07; // Enable UART0 on P0.4(TX) and P0.5(RX)      and smb0 and spi0               
	XBR1     = 0b0100_0000;
	XBR2     = 0x40; // Enable crossbar and weak pull-ups
	P0SKIP = 0b0000_1000; // Skip first pin and then use the last two for the SS
	P1MDIN &= 0b_1100_0011; // ADC pins
	P1SKIP |= 0b_0011_1000;

	// Configure Uart 0
	SCON0 = 0x10;
	CKCON0 |= 0b_0000_1000 ; // Timer 1 uses the system clock.
	TH1 = 0x100-((SYSCLK/BAUDRATE)/2L);
	TL1 = TH1;      // Init Timer1
	TMOD &= ~0xf0;  // TMOD: timer 1 in 8-bit auto-reload
	TMOD |=  0x20;                       
	TR1 = 1; // START Timer1
	TI = 1;  // Indicate TX0 ready
	
	// Configure SPI0
	SPI0CFG = 0b0100_0000; // not busy, master enable, first edge of clock, line in low idle
	SPI0CN0 = 0b0000_0001; // 3_wire mode and enable spi
	SPI0CKR =  (SYSCLK/(2*F_SCK_MAX))-1;; //48/(1*2)-1; // has to be between 0 and 255 
	
	// Configure I2C
	
		// Configure Timer 0 as the I2C clock source
	CKCON0 |= 0x04; // Timer0 clock source = SYSCLK
	TMOD &= 0xf0;  // Mask out timer 1 bits
	TMOD |= 0x02;  // Timer0 in 8-bit auto-reload mode
	// Timer 0 configured to overflow at 1/3 the rate defined by SMB_FREQUENCY
	TL0 = TH0 = (0x34 << TH1_TH1__SHIFT);
	TR0 = TCON_TR0__RUN; // Enable timer 0
	
	SMB0CF = 0b1101_0000;
	
	// Configure UART1
	
	SFRPAGE = 0x20;
	SMOD1 = 0x0C; 
	SCON1 = 0x10;
	SBCON1 =0x00;  
	SBRL1 = 0x10000L-((72000000/BAUDRATE)/(12L*2L));
	SCON1 |= 0x02;    
	SBCON1 |= 0x40;   
	SFRPAGE = 0x10; // Maybe change to 0x00;
	
	EA=1;				// Global Interrupts
	EIE2 = 0b0000_0100; // Timer 4 Interrupts
	
	
	
	LFO0CN = 0b1100_1100; // Enable the low frequency clock 
	
	SFRPAGE = 0x10;

	TMR4RLH= 0b1111_1101; // set the 16 bit timer high reload value
	TMR4RLL= 0b0000_1111; // set the 16 bit timer low reload value
	
	TMR4H= 0b1111_1101; // set the 16 bit timer high value
	TMR4L= 0b0000_1111; // set the 16 bit timer low value
	
	TMR4CN0 = 0b0000_0011; // Turn off timer for now. 
	SFRPAGE = 0x00;
	
	
	// Configure ADC

	return 0;
}

// Uses Timer3 to delay <us> micro-seconds. 
void Timer3us(unsigned char us)
{
	unsigned char i;               // usec counter
	
	// The input for Timer 3 is selected as SYSCLK by setting T3ML (bit 6) of CKCON0:
	CKCON0|=0b_0100_0000;
	
	TMR3RL = (-(SYSCLK)/1000000L); // Set Timer3 to overflow in 1us.
	TMR3 = TMR3RL;                 // Initialize Timer3 for first overflow
	
	TMR3CN0 = 0x04;                 // Sart Timer3 and clear overflow flag
	for (i = 0; i < us; i++)       // Count <us> overflows
	{
		while (!(TMR3CN0 & 0x80));  // Wait for overflow
		TMR3CN0 &= ~(0x80);         // Clear overflow indicator
	}
	TMR3CN0 = 0 ;                   // Stop Timer3 and clear overflow flag
}

void waitms (unsigned int ms)
{
	unsigned int j;
	unsigned char k;
	for(j=0; j<ms; j++)
		for (k=0; k<4; k++) Timer3us(250);
}

void SendByteSPI ()
{
	SFRPAGE = 0x00;
	OLED_SELECT = 0;
	SPI0DAT = 0xA5;
	while(!SPIF);
	SPIF = 0;
	Timer3us(5);
	OLED_SELECT = 1;
	return;
}

void oled_write(unsigned char d)
{
	SFRPAGE = 0x00;
	OLED_SELECT = 0;
	SPI0DAT = d;
	while(!SPIF);
	SPIF = 0;
	Timer3us(5);
	OLED_SELECT = 1;
	
}

void oled_write_16(unsigned char d1, unsigned char d2)
{
	SFRPAGE = 0x00;
	OLED_SELECT = 0;
	SPI0DAT = d1;
	while(!SPIF);
	SPIF = 0;
	
	SPI0DAT = d2;
	while(!SPIF);
	SPIF = 0;
	Timer3us(5);
	OLED_SELECT = 1;
}

void init_oled(){
	OLED_A0 = 0; // We are transmitting commands
	OLED_RESET = 1; // Set the reset pin high
	SPIF = 1; // Pull SPI high to reset 

	oled_write(0xAE); // turn off the display
	oled_write(0x40); // start the writes at the next two locations
	oled_write(0xA0); // remap
	oled_write(0xC8); // remap
	oled_write_16(0x81, 0x80); // set the contrast
	oled_write_16(0xA8, 0x3F); // 1/64 multiplex ratio
	oled_write_16(0xAD, 0x80); // disable built in dc-dc
	
	oled_write_16(0xD5, 0x50); // set internal clock speed
	oled_write_16(0xD3, 0x00); // display offset
	oled_write_16(0xD9, 0x22); // pixel driving capacitor pre-charge
	oled_write_16(0xDB, 0x35); // VCOM deselect
	oled_write_16(0xDC, 0x35); // capacitor output voltage
	oled_write(0x30); // discharge level
	oled_write(0xAF); // turn on the display
}

void clear_oled(){

	int i = 0;
	int y = 0;
	int x = 0;
	int length = 128;
	int c = 0;
	for (i = 0; i<64; i++){
		OLED_A0 = 0;
      	oled_write_16(0xB0, x);
      	oled_write( y & 15);
      	oled_write(0x010 | (y >> 4));
      	OLED_A0 = 1;
      	for (c = 0; c<length; c = c+1){			
		  	oled_write(0x00); // array would go here
		}
		OLED_A0 = 0;
		x = x+1;
	}

}

void draw_oled(){

	int i = 0;
	int x = 0;
	int y = 0;
	int length = 1;
	int c = 0;
	int sub_c = 0;
	int ptr = 0;
	
	for (y = 0; y<=124; y=y+4){
	for (i = 0; i<64; i++){
		sub_c = 0;
      	oled_write_16(0xB0, x);
      	oled_write( y & 15);
      	oled_write(0x010 | (y >> 4));
      	OLED_A0 = 1;
      	for (c = 0; c<length; sub_c = sub_c+2){

      		if ((vsn1[i+(y*16)] & ( 1 << sub_c )) >> sub_c == 1 && (vsn1[i+(y*16)] & ( 1 << (sub_c+1) )) >> (sub_c+1) == 1)			
		  	oled_write(0xFF);
		  	else if ((vsn1[i+(y*16)] & ( 1 << sub_c )) >> sub_c == 1 && (vsn1[i+(y*16)] & ( 1 << (sub_c+1) )) >> (sub_c+1) == 0)			
		  	oled_write(0xF0);
		  	else if ((vsn1[i+(y*16)] & ( 1 << sub_c )) >> sub_c == 0 && (vsn1[i+(y*16)] & ( 1 << (sub_c+1) )) >> (sub_c+1) == 1)			
		  	oled_write(0x0F);
		  	else 
		  	oled_write(0x00);
		  	if (sub_c >= 7){
      		c = c+1;
      		sub_c = 0;
      		}
		}
		OLED_A0 = 0;
		x = x+1;
	}
	
	}
}

void I2C_write (unsigned char output_data)
{
	SMB0DAT = output_data; // Put data into buffer
	SI = 0;
	while (!SI); // Wait until done with send
}

unsigned char I2C_read (void)
{
	unsigned char input_data;

	SI = 0;
	while (!SI); // Wait until we have data to read
	input_data = SMB0DAT; // Read the data

	return input_data;
}

void I2C_start (void)
{
	ACK = 1; 
	STA = 1;     // Send I2C start
	STO = 0;
	SI = 0;
	while (!SI); // Wait until start sent
	STA = 0;     // Reset I2C start
}

void I2C_stop(void)
{
	STO = 1;  	// Perform I2C stop
	SI = 0;	// Clear SI
}

void testi2c()
{
	unsigned int i = 0;
	
unsigned int control = 0x00;
	
	I2C_start();
	I2C_write(0xAA); //My address. as i'm not reading i don't need to or with 0x00000001
	I2C_write(control); // This is Command  
	I2C_stop();

	waitms(1);
	
	I2C_start();
	I2C_write(0xAB); //My address. as i'm not reading i don't need to or with 0x00000001
	I2C_write(control); // This is Command  
	I2C_stop();
	
	waitms(1);
	
	I2C_start();
	I2C_write(0x44); //My address. as i'm not reading i don't need to or with 0x00000001
	I2C_write(control); // This is Command  
	I2C_stop();
	
	waitms(1);
	
	I2C_start();
	I2C_write(0x47); //My address. as i'm not reading i don't need to or with 0x00000001
	I2C_write(control); // This is Command  
	I2C_stop();
	
	waitms(1);
	
	I2C_start();
	I2C_write(0x46); //My address. as i'm not reading i don't need to or with 0x00000001
	I2C_write(control); // This is Command  
	I2C_stop();
	
	waitms(10);
}

void senddata (char c) 
{
    SFRPAGE = 0x20;
	if (c == '\n') 
	{
		while (!(SCON1 & 0x02));
		SCON1 &= ~0x02;
		SBUF1 = '\r';
	}
	while (!(SCON1 & 0x02));
	SCON1 &= ~0x02;
	SBUF1 = c;
	SFRPAGE = 0x00;
}

char recievedata (void)
{
	char c;
    SFRPAGE = 0x20;
	while (!(SCON1 & 0x01));
	SCON1 &= ~0x01;
	SCON1&=0b_0011_1111;
	c = SBUF1;
	SFRPAGE = 0x00;
	return (c);
}

void low_power_sleep (){

//PCON1 = 0b1000_0000;

}


/////////////////////////////////////////////
// Core code for home button functionality //
/////////////////////////////////////////////
	
void btnpress() { // need to re-map pins to enable interrupts 

if (btn_press == 0) {
SFRPAGE = 0x10;
TMR4CN0 = 0b0000_0111; // Timer 4 start
SFRPAGE = 0x00;
btn_press = 1;
}

}

void stop_timer4 () {
SFRPAGE = 0x10;
TMR4CN0 = 0b0000_0011; //Stop the timer
SFRPAGE = 0x00;
}

void timer4_ISR (void) interrupt INTERRUPT_TIMER4 // Interrupt Service Routine for timer 4
{ 

SFRPAGE = 0x10;
TMR4CN0 = 0b0000_0111; //Reset the interrupt
SFRPAGE = 0x00;

if (BOOT == 0 && btn_state == 0){
btn_state = 1;
}

// Hold click pre-state

else if (BOOT == 0 && btn_state == 1){ // if high 
btn_state = 3;
}

// Double click or single click pre-state

else if (BOOT == 1 && btn_state == 1){
btn_state = 2;
}

// Hold click

else if (BOOT == 0 && btn_state == 3){ // if high 
btn_debug = 1;
btn_state = 0;
stop_timer4 ();
low_power_sleep ();
}

// Single click

else if (BOOT == 1 && btn_state == 2){ // if low 
btn_debug = 2;
btn_state = 0;
stop_timer4 ();
}

// Double click

else if (BOOT == 0 && btn_state == 2){ // if high 
btn_debug = 3;
btn_state = 0;
stop_timer4 ();
}

}	

//////////////////////////////////
// Core code for low power mode //
//////////////////////////////////



/////////////////////////////////
// Core code for main function //
/////////////////////////////////

void main (void)
{
	
	// Clear all pin states and reset
	STATUS1 = 1;
	NOTIF = 0;
	BLE_PWR = 1;
	ENABLE = 1;
	
	// Test Battery Level
	
	// Turn on LED to indicate that the controller is on
	
	
	// Vibrate motor to give feedback
	NOTIF = 1;
	waitms(20);
	NOTIF = 0;
	
	// Wake the board
	
	// Turn on magnetoresistor sensor
	ENABLE = 0;

	
	// Display Init sequence
	init_oled();
	clear_oled();
	draw_oled();
	P1_6 = 0; // 
	
	while(1)
	{
		if (DEADMAN == 0){ // if the deadmans trigger is pressed down then send data
		//testi2c();
			printf("%i", btn_debug);
		}
		
		if (BOOT == 0){ btnpress(); } 					// Core code for home button functionality
		else { if (btn_state != 2){ btn_press = 0; } }	// keep these two lines together. 
		
	}
}	

